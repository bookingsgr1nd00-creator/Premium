<!doctype html>
<html lang="en-CA">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Premium Supply — Category</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="styles.css" />
</head>

<body data-page="listing">
  <!-- Toggles -->
  <input class="toggle" type="checkbox" id="catDrawerToggle">
  <input class="toggle" type="checkbox" id="searchToggle">

  <!-- Search modal (filters this category page) -->
  <div class="search-modal" role="dialog" aria-modal="true" aria-labelledby="searchTitle">
    <label for="searchToggle" class="search-modal__overlay" aria-hidden="true"></label>
    <div class="search-modal__panel">
      <div class="search-modal__head">
        <h2 class="search-modal__title" id="searchTitle">Search</h2>
        <label class="icon-btn" for="searchToggle" aria-label="Close search"><i class="fa-solid fa-xmark"></i></label>
      </div>

      <div class="search-box">
        <label class="sr-only" for="searchInput">Search</label>
        <input id="searchInput" type="search" placeholder="Search products…" autocomplete="off">
        <button class="btn btn--outline" type="button" id="clearSearch">Clear</button>
      </div>

      <div class="sort-row">
        <span class="muted">Sort:</span>
        <select id="sortSelect" aria-label="Sort products">
          <option value="price_desc" selected>Price: High → Low</option>
          <option value="price_asc">Price: Low → High</option>
          <option value="rating_desc">Rating: High → Low</option>
        </select>
      </div>

      <p class="muted" style="margin:10px 0 0;">
        Tip: search works inside this category page (no external services).
      </p>
    </div>
  </div>

  <!-- Topbar -->
  <div class="topbar">
    <div class="container topbar__inner">
      <span class="topbar__badge"><i class="fa-solid fa-maple-leaf"></i> 100% Canadian</span>
      <p class="topbar__text" id="topbarText">Category</p>
      <a class="topbar__link" href="products.html">All products</a>
    </div>
  </div>

  <!-- Header -->
  <header class="header">
    <div class="container header__inner">
      <label class="icon-btn" for="catDrawerToggle" aria-label="Open categories"><i class="fa-solid fa-bars"></i></label>

      <a class="brand" href="products.html" aria-label="Premium Supply - All products">
        <svg class="brand__logo" viewBox="0 0 64 64" aria-hidden="true">
          <defs>
            <radialGradient id="g2" cx="30%" cy="30%" r="70%">
              <stop offset="0" stop-color="#E6D7FF"/>
              <stop offset="1" stop-color="#6A2DFF"/>
            </radialGradient>
          </defs>
          <circle cx="32" cy="32" r="18" fill="url(#g2)"></circle>
          <path d="M10 34c10 10 34 10 44 0" fill="none" stroke="#B8F3D0" stroke-width="3" stroke-linecap="round"/>
          <path d="M14 28c10-10 30-10 40 0" fill="none" stroke="#F2D48B" stroke-width="3" stroke-linecap="round" opacity=".9"/>
        </svg>

        <span class="brand__text">
          <span class="brand__name">Premium Supply</span>
          <span class="brand__tag" id="brandTag">Category</span>
        </span>
      </a>

      <div class="header__right">
        <label class="icon-btn" for="searchToggle" aria-label="Search"><i class="fa-solid fa-magnifying-glass"></i></label>

        <a class="icon-btn cart-btn" href="cart.html" aria-label="Cart">
          <i class="fa-solid fa-bag-shopping"></i>
          <span class="cart-badge js-cart-count">0</span>
        </a>
      </div>
    </div>
  </header>

  <!-- Drawer -->
  <label for="catDrawerToggle" class="drawer-backdrop" aria-hidden="true"></label>
  <aside class="drawer" aria-label="Shop by category">
    <div class="drawer__head">
      <div class="drawer__title"><i class="fa-solid fa-list"></i> Shop by category</div>
      <label class="icon-btn" for="catDrawerToggle" aria-label="Close"><i class="fa-solid fa-xmark"></i></label>
    </div>

    <nav class="cat-nav">
      <a class="cat-link" href="products.html">All Products</a>
      <div class="cat-sep"></div>

      <!-- categories injected here -->
      <div id="dynamicCategories"></div>

      <div class="cat-sep"></div>
      <a class="cat-link" href="cart.html">Cart</a>
      <a class="cat-link" href="checkout.html">Checkout</a>
    </nav>
  </aside>

  <main class="section">
    <div class="container">
      <section class="block">
        <div class="block__head">
          <h1 class="block__title" id="pageTitle">Category</h1>
          <p class="block__sub" id="pageSub">Browse products in this category.</p>
        </div>

        <div class="products-grid" id="productGrid" aria-live="polite"></div>
      </section>

      <footer class="block muted">
        <p style="margin:0;">© 2026 Premium Supply • Proudly Canadian</p>
      </footer>
    </div>
  </main>

  <div class="toast" id="toast" role="status" aria-live="polite">
    <span id="toastText">Added to cart.</span>
    <a href="cart.html">View cart</a>
  </div>

  <script>
    /* ===== Config ===== */
    const PS = {
      currency: "CAD",
      cartKey: "ps_cart_v1"
    };

    /* ===== Helpers ===== */
    const $ = (s, el=document) => el.querySelector(s);
    const $$ = (s, el=document) => Array.from(el.querySelectorAll(s));

   const CATEGORY_ORDER = [
  "Flower",
  "Concentrates",
  "Edibles",
  "Vapes",
  "CBD",
  "Male Enhancers"
];

    const money = (n) =>
      new Intl.NumberFormat("en-CA", { style:"currency", currency: PS.currency }).format(n);

    function getParam(name){
      return new URLSearchParams(location.search).get(name);
    }

    function readCart(){
      try { return JSON.parse(localStorage.getItem(PS.cartKey) || "{}"); }
      catch { return {}; }
    }
    function writeCart(cart){
      localStorage.setItem(PS.cartKey, JSON.stringify(cart));
    }
    function cartCount(cart){
      return Object.values(cart).reduce((sum, item) => sum + (item.qty || 0), 0);
    }
    function updateBadges(){
      const count = cartCount(readCart());
      $$(".js-cart-count").forEach(el => el.textContent = String(count));
    }

    function showToast(msg){
      const toast = $("#toast");
      $("#toastText").textContent = msg;
      toast.classList.add("toast--show");
      window.clearTimeout(showToast._t);
      showToast._t = window.setTimeout(() => toast.classList.remove("toast--show"), 2200);
    }

    function toStarHTML(rating){
      const r = Math.round((Number(rating)||0) * 2) / 2;
      const full = Math.floor(r);
      const half = (r - full) >= 0.5;
      let html = "";
      for(let i=0;i<full;i++) html += '<i class="fa-solid fa-star"></i>';
      if(half) html += '<i class="fa-solid fa-star-half-stroke"></i>';
      const empty = 5 - full - (half ? 1 : 0);
      for(let i=0;i<empty;i++) html += '<i class="fa-regular fa-star"></i>';
      return html;
    }

    function typeClass(type){
      const t = (type||"").toLowerCase();
      if(t.includes("indica")) return "type-strip--indica";
      if(t.includes("hybrid")) return "type-strip--hybrid";
      if(t.includes("sativa")) return "type-strip--sativa";
      return "type-strip--other";
    }

    async function loadCatalog(){
      const res = await fetch("catalog.json", { cache: "no-store" });
      if(!res.ok) throw new Error("Could not load catalog.json");
      return await res.json();
    }

    /* ===== Categories (auto list + main set) ===== */
    function renderCategoryLinks(catalog){
      const CATEGORY_ORDER = [
        "Flower",
        "Pre-Rolls",
        "Concentrates",
        "Vape",
        "Edibles",
        "CBD",
        "Bundles",
        "Accessories"
      ];

      const fromCatalog = [...new Set(catalog.map(p => p.category).filter(Boolean))];

      const cats = [
        ...CATEGORY_ORDER,
        ...fromCatalog.filter(c => !CATEGORY_ORDER.includes(c))
      ].filter(Boolean);

      const mount = $("#dynamicCategories");
      mount.innerHTML = cats.map(c =>
        `<a class="cat-link" href="category.html?c=${encodeURIComponent(c)}">${c}</a>`
      ).join("");
    }

    /* ===== Product card (NO flavor circles) ===== */
    function productCard(p){
      const sale = (p.badges || []).map(b => String(b).toLowerCase()).includes("sale");

      const mediaInner = p.image
        ? `<img class="img-square" src="${p.image}" alt="${p.name}">`
        : `<div class="img-square" aria-hidden="true"></div>`;

      return `
        <article class="product-tile" data-id="${p.id}">
          <div class="product-tile__media">
            ${sale ? `<span class="sale-bubble">Sale!</span>` : ""}

            <a class="product-link" href="product.html?id=${encodeURIComponent(p.id)}" aria-label="View ${p.name}">
              ${mediaInner}
              <div class="type-strip ${typeClass(p.type)}">${p.type || "—"}</div>
            </a>
          </div>

          <div class="product-tile__body">
            <div class="pill-row">
              <span class="pill pill--tier">${p.tier || "Premium"}</span>
              <span class="pill pill--tag">${p.tag || p.category}</span>
            </div>

            <a class="product-title-link" href="product.html?id=${encodeURIComponent(p.id)}">${p.name}</a>

            <div class="rating">
              <div class="stars" aria-label="${p.rating} stars">${toStarHTML(p.rating)}</div>
              <div class="reviews">${Number(p.reviews||0)} reviews</div>
            </div>

            <div class="price">${money(Number(p.price||0))} ${PS.currency}</div>

            <div class="buy-row">
              <div class="qty">
                <span>Quantity</span>
                <div class="qty-stepper">
                  <button class="qty-btn js-minus" type="button" data-id="${p.id}">−</button>
                  <input class="qty-input js-qty" type="number" min="1" value="1" data-id="${p.id}">
                  <button class="qty-btn js-plus" type="button" data-id="${p.id}">+</button>
                </div>
              </div>

              <button class="btn btn--solid btn--full js-buy" type="button" data-id="${p.id}">
                Buy
              </button>
            </div>
          </div>
        </article>
      `;
    }

    /* ===== Init ===== */
    (async function init(){
      updateBadges();

      const c = (getParam("c") || "").trim();
      const qParam = (getParam("q") || "").trim();

      const grid = $("#productGrid");
      const searchInput = $("#searchInput");
      const clearSearch = $("#clearSearch");
      const sortSelect = $("#sortSelect");

      // Set titles
      const categoryName = c || "Category";
      $("#pageTitle").textContent = categoryName;
      $("#brandTag").textContent = categoryName;
      $("#topbarText").textContent = `Category: ${categoryName}`;
      $("#pageSub").textContent = `Browse products in ${categoryName}.`;

      // Prefill search from URL if provided
      if(qParam) searchInput.value = qParam;

      const catalog = await loadCatalog();
      renderCategoryLinks(catalog);

      // Filter by category (case-insensitive)
      const target = categoryName.toLowerCase();

      function filterAndSort(){
        const q = (searchInput.value || "").trim().toLowerCase();
        const sort = sortSelect.value;

        let list = catalog.slice();

        // If no category provided, show all (still works)
        if(c){
          list = list.filter(p => String(p.category||"").toLowerCase() === target);
        }

        if(q){
          list = list.filter(p => {
            const blob = [p.name, p.category, p.type, p.tier, p.tag, ...(p.badges||[])].join(" ").toLowerCase();
            return blob.includes(q);
          });
        }

        list.sort((a,b) => {
          if(sort === "price_asc") return (a.price||0) - (b.price||0);
          if(sort === "rating_desc") return (b.rating||0) - (a.rating||0);
          return (b.price||0) - (a.price||0); // price_desc default
        });

        return list;
      }

      function render(){
        const list = filterAndSort();
        if(!list.length){
          grid.innerHTML = `
            <div class="card" style="grid-column:1/-1;">
              <strong>No products found.</strong>
              <p class="muted" style="margin:.5rem 0 0;">
                Try a different search or add products to this category in <span class="mono">catalog.json</span>.
              </p>
            </div>
          `;
          return;
        }
        grid.innerHTML = list.map(productCard).join("");
      }

      clearSearch.addEventListener("click", () => { searchInput.value = ""; render(); });
      sortSelect.addEventListener("change", render);
      searchInput.addEventListener("input", render);

      // Quantity stepper + Buy
      document.addEventListener("click", (e) => {
        const plus = e.target.closest(".js-plus");
        const minus = e.target.closest(".js-minus");
        const buy = e.target.closest(".js-buy");

        if(plus){
          const id = plus.dataset.id;
          const input = document.querySelector(`.js-qty[data-id="${id}"]`);
          input.value = String(Math.max(1, (Number(input.value)||1) + 1));
        }

        if(minus){
          const id = minus.dataset.id;
          const input = document.querySelector(`.js-qty[data-id="${id}"]`);
          input.value = String(Math.max(1, (Number(input.value)||1) - 1));
        }

        if(buy){
          const id = buy.dataset.id;
          const qtyInput = document.querySelector(`.js-qty[data-id="${id}"]`);
          const qty = Math.max(1, Number(qtyInput?.value || 1));

          const p = catalog.find(x => x.id === id);
          if(!p) return;

          const cart = readCart();
          if(cart[id]) cart[id].qty += qty;
          else cart[id] = {
            id: p.id,
            name: p.name,
            price: Number(p.price||0),
            category: p.category,
            type: p.type,
            tier: p.tier,
            qty: qty
          };

          writeCart(cart);
          updateBadges();
          showToast(`Added ${qty} × ${p.name}`);
        }
      });

      render();
    })().catch(err => {
      console.error(err);
      document.querySelector("#productGrid").innerHTML =
        `<div class="card" style="grid-column:1/-1;">
          <strong>Catalog failed to load.</strong>
          <p class="muted" style="margin:.5rem 0 0;">
            Make sure <span class="mono">catalog.json</span> is in the same folder as <span class="mono">category.html</span>.
          </p>
        </div>`;
    });
  </script>
</body>
</html>